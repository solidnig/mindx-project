<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gửi công thức — How to Cook</title>

    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: #f7f7f7;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #ffffff;
        padding: 15px 30px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: #e67e22;
      }

      nav a {
        margin-left: 25px;
        text-decoration: none;
        color: #333;
        font-size: 16px;
        transition: 0.2s;
      }

      nav a:hover {
        color: #e67e22;
      }

      h1 {
        text-align: center;
        color: #e67e22;
      }
      .box {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        max-width: 700px;
        margin: auto;
      }
      label {
        font-weight: bold;
        display: block;
        margin-top: 15px;
      }
      input,
      textarea {
        width: 100%;
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        margin-top: 5px;
      }
      button {
        margin-top: 15px;
        padding: 10px 16px;
        background: #e67e22;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      ul {
        margin-top: 10px;
        padding-left: 20px;
      }
      .user-area {
        position: relative;
        display: none; /* Ẩn mặc định, sẽ hiện khi đăng nhập */
        cursor: pointer;
      }

      #showName {
        padding: 6px 12px;
        color: #e67e22;
        font-weight: bold;
      }

      .dropdown {
        position: absolute;
        top: 28px;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        display: none;
        min-width: 120px;
        z-index: 10;
      }

      .dropdown button {
        width: 100%;
        padding: 10px;
        background: white;
        border: none;
        text-align: left;
        cursor: pointer;
      }

      .dropdown button:hover {
        background: #f2f2f2;
      }

      /* Hover để hiện menu */
      .user-area:hover .dropdown {
        display: block;
      }
    </style>
  </head>

  <body>
    <header>
      <div
        class="logo"
        onclick="window.location.href='index.html'"
        style="cursor: pointer"
      >
        How to Cook
      </div>

      <nav>
        <a href="#">Đồ ăn</a>
        <a href="#">Đồ uống</a>
        <a href="send-recipe.html">Gửi công thức</a>

        <!-- Nút đăng nhập (ẩn khi login thành công) -->
        <a href="login.html" id="loginBtn">Đăng nhập</a>

        <!-- Username + menu logout -->
        <div id="userMenu" class="user-area">
          <span id="showName"></span>
          <div class="dropdown" id="logoutDropdown">
            <button onclick="logout()">Đăng xuất</button>
          </div>
        </div>
      </nav>
    </header>
    <h1>Gửi công thức mới</h1>

    <div class="box">
      <label>Hình minh họa</label>
      <input type="file" id="img" accept="image/*" />

      <label>Tên món ăn</label>
      <input type="text" id="ten" placeholder="Nhập tên món ăn..." />

      <label>Ghi chú</label>
      <input type="text" id="ghi_chu" placeholder="Mô tả ngắn về món ăn" />

      <hr />

      <label>Nguyên liệu</label>
      <div style="display: flex; gap: 10px">
        <input type="text" id="ing" placeholder="Nhập nguyên liệu..." />
        <button type="button" onclick="addIngredient()">Thêm</button>
      </div>
      <ul id="listIng"></ul>

      <hr />

      <label>Cách làm</label>
      <input
        type="text"
        id="stTitle"
        placeholder="Tiêu đề bước (ví dụ: Bước 1 — Sơ chế)"
      />
      <textarea id="stDesc" placeholder="Mô tả chi tiết bước"></textarea>
      <button type="button" onclick="addStep()">Thêm bước</button>

      <ul id="listStep"></ul>

      <hr />

      <label>Mẹo (không bắt buộc)</label>
      <textarea
        id="tip"
        placeholder="Ví dụ: Đun lửa nhỏ để nước trong hơn"
      ></textarea>

      <button
        onclick="saveRecipe()"
        style="width: 100%; font-size: 18px; margin-top: 25px"
      >
        Lưu công thức
      </button>
    </div>

    <script>
      let ingredients = [];
      let steps = [];

      /* ============================
   THÊM NGUYÊN LIỆU
============================ */
      function addIngredient() {
        const ing = document.getElementById("ing").value.trim();
        if (ing) {
          ingredients.push(ing);
          document.getElementById("listIng").innerHTML += `<li>${ing}</li>`;
          document.getElementById("ing").value = "";
        }
      }

      /* ============================
   THÊM BƯỚC LÀM
============================ */
      function addStep() {
        const title = document.getElementById("stTitle").value.trim();
        const desc = document.getElementById("stDesc").value.trim();

        if (title && desc) {
          steps.push({ tieu_de: title, mo_ta: desc });

          document.getElementById("listStep").innerHTML += `
            <li><b>${title}</b>: ${desc}</li>
        `;

          document.getElementById("stTitle").value = "";
          document.getElementById("stDesc").value = "";
        }
      }

      /* ============================
   CHUYỂN IMAGE → BASE64
============================ */
      function toBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = (error) => reject(error);
        });
      }

      /* ============================
   LƯU CÔNG THỨC
============================ */
      async function saveRecipe() {
        const name = document.getElementById("ten").value.trim();
        const note = document.getElementById("ghi_chu").value.trim();
        const tip = document.getElementById("tip").value.trim();
        const file = document.getElementById("img").files[0];

        if (!name) {
          alert("Tên món ăn không được để trống!");
          return;
        }

        let imageBase64 = "";
        if (file) {
          imageBase64 = await toBase64(file);
        }

        const recipe = {
          ten: name,
          ghi_chu: note,
          nguyen_lieu: ingredients,
          cach_lam: steps,
          tip: tip === "" ? null : tip,
          image: imageBase64,
        };

        let data = JSON.parse(localStorage.getItem("recipes")) || [];
        data.push(recipe);
        localStorage.setItem("recipes", JSON.stringify(data));

        alert("Đã lưu công thức!");
        window.location.href = "index.html";
      }
    </script>
    <script>
      // Kiểm tra trạng thái đăng nhập và hiển thị username
      (function () {
        const loginBtn = document.getElementById("loginBtn");
        const userMenu = document.getElementById("userMenu");
        const nameEl = document.getElementById("showName");

        const user = JSON.parse(localStorage.getItem("currentUser"));

        if (user) {
          // Ẩn nút đăng nhập
          if (loginBtn) loginBtn.style.display = "none";

          // Hiện username
          userMenu.style.display = "inline-block";
          nameEl.innerText = user.displayName;
        } else {
          // Chưa đăng nhập → Ẩn userMenu
          if (userMenu) userMenu.style.display = "none";
        }
      })();

      // Đăng xuất
      function logout() {
        localStorage.removeItem("currentUser");
        window.location.reload();
      }
    </script>
  </body>
</html>
